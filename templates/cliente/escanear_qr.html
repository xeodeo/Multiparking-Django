{% extends "cliente/base.html" %}
{% block title %}Escanear QR{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header Simple -->
    <div class="mb-6 text-center">
        <h1 class="text-2xl font-bold mb-2">üì∑ Escanear QR</h1>
        <p class="text-mp-muted text-sm">Apunta tu c√°mara al c√≥digo en la entrada</p>
    </div>

    <!-- Paso 1: Permitir C√°mara -->
    <div id="step-1" class="bg-yellow-900/20 border-2 border-yellow-500/50 rounded-xl p-6 mb-4">
        <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-yellow-500 text-black flex items-center justify-center font-bold text-xl flex-shrink-0">
                1
            </div>
            <div>
                <h3 class="font-bold text-yellow-300 text-lg mb-2">Permitir uso de c√°mara</h3>
                <p class="text-yellow-200 text-sm mb-3">Tu navegador te pedir√° permiso. Haz clic en <strong>"Permitir"</strong> o <strong>"Allow"</strong>.</p>
                <div class="bg-yellow-500/10 rounded-lg p-3 border border-yellow-500/30">
                    <p class="text-xs text-yellow-300">üí° Si no aparece nada, verifica que tu dispositivo tenga c√°mara y que est√© habilitada.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Container -->
    <div class="bg-mp-card border-2 border-mp-purple rounded-xl overflow-hidden mb-4">
        <div class="bg-mp-purple/10 px-4 py-3 border-b border-mp-border">
            <div id="scanner-status" class="flex items-center justify-center gap-2">
                <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                <span class="text-sm font-medium">Iniciando c√°mara...</span>
            </div>
        </div>
        <div id="reader" class="bg-black"></div>
    </div>

    <!-- Paso 2: Escanear -->
    <div class="bg-purple-900/20 border-2 border-purple-500/50 rounded-xl p-6 mb-4">
        <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold text-xl flex-shrink-0">
                2
            </div>
            <div>
                <h3 class="font-bold text-purple-300 text-lg mb-2">Apunta al c√≥digo QR</h3>
                <p class="text-purple-200 text-sm mb-3">Busca el c√≥digo QR en la entrada del parqueadero y apunta tu c√°mara hacia √©l.</p>
                <div class="bg-purple-500/10 rounded-lg p-3 border border-purple-500/30">
                    <p class="text-xs text-purple-300">üí° Mant√©n el c√≥digo dentro del recuadro. Se detectar√° autom√°ticamente.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n alternativo grande -->
    <div class="bg-mp-card border border-mp-border rounded-xl p-6 text-center">
        <p class="text-mp-muted mb-4">¬øNo funciona la c√°mara?</p>
        <a href="{% url 'entrada_parqueadero' %}" class="inline-flex items-center gap-2 bg-mp-purple hover:bg-mp-purple-dark text-white px-6 py-3 rounded-lg font-medium transition">
            Ingresar sin escanear
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
            </svg>
        </a>
    </div>

    <!-- Bot√≥n Volver -->
    <div class="mt-6 text-center">
        <a href="{% url 'dashboard' %}" class="text-mp-muted hover:text-white transition inline-flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Volver
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const BASE_URL = window.location.origin;
const TARGET_URL = `${BASE_URL}/parqueadero/entrada/`;

let html5QrcodeScanner;

function onScanSuccess(decodedText, decodedResult) {
    // Detener el esc√°ner
    html5QrcodeScanner.clear();

    // Actualizar el estado
    document.getElementById('scanner-status').innerHTML = `
        <div class="flex items-center gap-2 text-green-400">
            <svg class="w-5 h-5 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm font-bold">‚úì ¬°Detectado! Procesando...</span>
        </div>
    `;

    // Verificar si es la URL correcta o redirigir directamente
    if (decodedText.includes('/parqueadero/entrada/')) {
        // Redirigir a la p√°gina de entrada
        setTimeout(() => {
            window.location.href = TARGET_URL;
        }, 500);
    } else {
        // Si no es la URL correcta, mostrar error
        document.getElementById('scanner-status').innerHTML = `
            <div class="flex items-center gap-2 text-red-400">
                <svg class="w-5 h-5 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm font-bold">‚úó QR incorrecto. Usa el QR del parqueadero</span>
            </div>
        `;
        // Reiniciar el esc√°ner despu√©s de 2 segundos
        setTimeout(() => {
            initScanner();
        }, 2000);
    }
}

function onScanError(errorMessage) {
    // Ignorar errores de escaneo continuo (son normales)
}

function initScanner() {
    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            rememberLastUsedCamera: true
        },
        false
    );

    html5QrcodeScanner.render(onScanSuccess, onScanError);

    // Actualizar estado cuando la c√°mara est√° lista
    setTimeout(() => {
        document.getElementById('scanner-status').innerHTML = `
            <div class="flex items-center gap-2 text-green-400">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-sm font-medium">‚úì C√°mara lista - Apunta al QR ahora</span>
            </div>
        `;

        // Resaltar el paso 2
        document.getElementById('step-1').classList.remove('border-yellow-500/50');
        document.getElementById('step-1').classList.add('border-yellow-500/20', 'opacity-60');
    }, 1500);
}

// Iniciar el esc√°ner cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    initScanner();
});
</script>
{% endblock %}
