{% extends "cliente/base.html" %}
{% block title %}Escanear QR{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="mb-8 text-center">
        <div class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-purple-500/20 to-purple-900/20 flex items-center justify-center border-2 border-purple-500/30 animate-pulse">
            <svg class="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
            </svg>
        </div>
        <h1 class="text-3xl font-bold mb-2">Escanear Código QR</h1>
        <p class="text-mp-muted">Apunta tu cámara al código QR ubicado en la entrada</p>
    </div>

    <!-- Scanner Container -->
    <div class="bg-mp-card border border-mp-border rounded-xl p-6 mb-6">
        <div id="reader" class="rounded-lg overflow-hidden"></div>

        <!-- Estado del escáner -->
        <div id="scanner-status" class="mt-4 text-center">
            <div class="inline-flex items-center gap-2 text-mp-muted">
                <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                <span class="text-sm">Iniciando cámara...</span>
            </div>
        </div>
    </div>

    <!-- Instrucciones -->
    <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-6">
        <h3 class="font-bold text-blue-300 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Instrucciones:
        </h3>
        <ul class="text-sm text-blue-200 space-y-2">
            <li class="flex items-start gap-2">
                <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Permite el acceso a la cámara cuando te lo solicite el navegador
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Apunta la cámara al código QR ubicado en la entrada del parqueadero
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Mantén el código dentro del recuadro hasta que se detecte
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                El sistema te redirigirá automáticamente al siguiente paso
            </li>
        </ul>
    </div>

    <!-- Botón alternativo -->
    <div class="text-center">
        <p class="text-sm text-mp-muted mb-4">¿No puedes escanear el código?</p>
        <a href="{% url 'entrada_parqueadero' %}" class="inline-flex items-center gap-2 text-mp-purple hover:text-mp-purple-dark transition font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
            </svg>
            Ingresar manualmente
        </a>
    </div>

    <!-- Botón Volver -->
    <div class="mt-8 text-center">
        <a href="{% url 'dashboard' %}" class="text-mp-muted hover:text-white transition inline-flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Volver al Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const BASE_URL = window.location.origin;
const TARGET_URL = `${BASE_URL}/parqueadero/entrada/`;

let html5QrcodeScanner;

function onScanSuccess(decodedText, decodedResult) {
    // Detener el escáner
    html5QrcodeScanner.clear();

    // Actualizar el estado
    document.getElementById('scanner-status').innerHTML = `
        <div class="inline-flex items-center gap-2 text-green-400">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm font-bold">¡QR detectado! Redirigiendo...</span>
        </div>
    `;

    // Verificar si es la URL correcta o redirigir directamente
    if (decodedText.includes('/parqueadero/entrada/')) {
        // Redirigir a la página de entrada
        setTimeout(() => {
            window.location.href = TARGET_URL;
        }, 500);
    } else {
        // Si no es la URL correcta, mostrar error
        document.getElementById('scanner-status').innerHTML = `
            <div class="inline-flex items-center gap-2 text-red-400">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm font-bold">Código QR incorrecto. Escanea el código del parqueadero.</span>
            </div>
        `;
        // Reiniciar el escáner después de 2 segundos
        setTimeout(() => {
            initScanner();
        }, 2000);
    }
}

function onScanError(errorMessage) {
    // Ignorar errores de escaneo continuo (son normales)
}

function initScanner() {
    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            rememberLastUsedCamera: true
        },
        false
    );

    html5QrcodeScanner.render(onScanSuccess, onScanError);

    // Actualizar estado cuando la cámara está lista
    setTimeout(() => {
        document.getElementById('scanner-status').innerHTML = `
            <div class="inline-flex items-center gap-2 text-green-400">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-sm">Cámara activa - Apunta al código QR</span>
            </div>
        `;
    }, 1000);
}

// Iniciar el escáner cuando se carga la página
document.addEventListener('DOMContentLoaded', () => {
    initScanner();
});
</script>
{% endblock %}
